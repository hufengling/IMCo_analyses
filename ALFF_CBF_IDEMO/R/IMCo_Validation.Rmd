---
title: "IMCo Validation - Three Modality - ALFF_CBF_IDEMO"
author: "Fengling Hu"
output: html_document
---

# Setup
```{r, include = FALSE}
library(tidyverse)
library(ANTsRCore)
library(extrantsr)
library(IMCo)
library(parallel)
library(here)
```

## Load niftis
```{r}
idemo_qa <- read_csv(here("input/csvs/idemodata/n1601_idemo_FinalQA_092817.csv"))
idemo <- read_csv(here("input/csvs/idemodata/n1601_idemoBehavior_20151130.csv"))
idemo_health <- read_csv(here("input/csvs/idemodata/n1601_health_20170421.csv"))
pnc_demographics <- read_csv(here("input/csvs/demographics/binded_demographics.csv"))

idemo_qa <- idemo_qa %>% filter(idemoExcludeVoxelwise == 0)
idemo <- idemo %>% filter(idemoBehHappyCorrectCount >= 8)
idemo_health <- idemo_health %>% filter(ltnExcludev2 == 0)
pnc_demographics <- pnc_demographics %>% rename(scanid = "id")

common_pts <- Reduce(intersect, list(idemo_qa$scanid, idemo$scanid, idemo_health$scanid, pnc_demographics$scanid)) %>%
  as.data.frame() %>%
  rename(subj_num = ".")

input_filepaths <- common_pts %>% 
  mutate(modality_1 = paste0(subj_num, "_alffStd.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/alff", .),
         modality_2 = paste0(subj_num, "_asl_quant_ssT1Std.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/cbf", .), 
         modality_3 = paste0(subj_num, "_sigchange_cope1_TaskStd.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/idemo", .))

write_csv(input_filepaths, here("input/csvs/input_filepaths.csv"))

rm(common_pts, idemo, idemo_health, idemo_qa)
```

## Write settings
```{r}
output_dir <- here("output") #base directory for all outputs
input_dir <- here("input") #base directory for all inputs
mask_path <- file.path(input_dir, "references/masks/gm10_pcals_rest.nii.gz")
batch_script_dir <- here("R/batch_scripts")
fwhm <- 3
propMiss <- 0.9

settings <- list(input_filepaths_path = file.path(input_dir, "csvs/input_filepaths.csv"),
                 output_dir = output_dir,
                 input_dir = input_dir,
                 batch_script_dir = batch_script_dir,
                 mask_path = mask_path,
                 fwhm = fwhm,
                 propMiss = propMiss)
input_filepaths <- read_csv(file.path(input_dir, "csvs/input_filepaths.csv"))

save(settings, file = file.path(input_dir, "csvs/settings.RData"))

rm(output_dir, input_dir, mask_path, batch_script_dir, fwhm, propMiss)
```

## Load non-nifti PNC data
```{r}
demographics <- read_csv(here("input/csvs/demographics/binded_demographics.csv")) %>% 
  rename(subj_num = id)
demographics <- right_join(demographics, input_filepaths, 
                           by = "subj_num") %>% 
  mutate(across(contains("Exclude"), as.factor),
         sex = case_when(
           sex == 1 ~ "Male",
           sex == 2 ~ "Female",
           T ~ NA_character_),
         race2 = case_when(
           race2 == 1 ~ "White",
           race2 == 2 ~ "Black",
           race2 == 3 ~ "Other",
           T ~ NA_character_),
         across(c(sex, race, race2, ethnicity, handednessv2), as.factor))
predictors <- demographics %>%
  select(sex, ageAtScan1, race2, pcaslRelMeanRMSMotion, restRelMeanRMSMotion)

rm(demographics)
```

# Write IMCo bash script
```{r}
bash_file <- rep(0, nrow(input_filepaths))
for(i in 1:nrow(input_filepaths)) {
  line <- input_filepaths[i, ]
  out_name <- line[1]
  subject_files <- paste(line[1, 2], line[1, 3], line[1, 4], sep = ",")
  
  bsub_args <- paste("bsub",
                     "-q taki_normal",
                     paste("-J", shQuote("intermodal_coupling")),
                     paste("-R", shQuote("rusage[mem=4000]")),
                     "-M 10000",
                     paste("-o", file.path(settings$output_dir, "stdout/intermodal_coupling.txt")))
  
  Rscript_args <- paste("Rscript", here("R/batch_scripts/01_perform_imco.R"),
                        subject_files,
                        settings$mask_path,
                        settings$output_dir,
                        out_name,
                        settings$fwhm,
                        settings$propMiss)
  bash_file[i] <- paste(bsub_args, Rscript_args)
}

write_lines(bash_file, file.path(settings$batch_script_dir, "01_commands.sh"))
#RUNOTHER
```

# Calculate p-values

## Functions
```{r}
load_images <- function(dir, mask) {
  files <- list.files(dir)
  file_paths <- file.path(dir, files)
  image_vector_list <- lapply(file_paths,
                              function(x, mask) {
                                image <- extrantsr::check_ants(x)
                                image[mask == 0] <- NA
                                image_vector <- image %>% as.numeric()
                                image_vector_no_NAs <- image_vector[!is.na(image_vector)]
                                return(image_vector_no_NAs)
                              },
                              mask = mask
  )
  return(image_vector_list)
}

transpose_list <- function(list) {
  matrix <- list %>%
    unlist() %>%
    matrix(byrow = TRUE, nrow = length(list))
  transposed_list <- lapply(seq_len(ncol(matrix)), function(i) matrix[, i])
  return(transposed_list)
}

make_descriptive_images <- function(voxel_vector_list) {
  descriptive_vector <- lapply(voxel_vector_list, function(voxel_vector) {
    voxel_mean <- sum(voxel_vector)/length(voxel_vector)
    voxel_variance <- var(voxel_vector)
    
    return(c(voxel_mean, voxel_variance))
  }) %>% unlist()
  
  voxel_mean_vector <- descriptive_vector[c(T, F)]
  voxel_variance_vector <- descriptive_vector[c(F, T)]
  
  return(list(voxel_mean_vector, voxel_variance_vector))
}

get_pvals_by_voxel <- function(voxel_vector, predictors) {
  if (length(voxel_vector) != nrow(predictors)) {
    stop("n doesn't match")
  }
  
  regression <- lm(voxel_vector ~
                     sex + ageAtScan1 +
                     race2 + pcaslRelMeanRMSMotion + restRelMeanRMSMotion,
                   data = predictors) %>%
    summary()
  reg_pvals <- regression$coefficients[c(2, 3), 4]
  
  interaction_regression <- lm(voxel_vector ~
                                 sex * ageAtScan1 +
                                 race2 + pcaslRelMeanRMSMotion + restRelMeanRMSMotion,
                               data = predictors) %>%
    summary()
  int_pvals <- interaction_regression$coefficients[8, 4]
  
  pvals <- c(reg_pvals, int_pvals)
  return(pvals)
}

write_pvals <- function(image_list, mask, dir, is_descriptive = FALSE) {
  mask_indices <- which(as.array(mask) > 0)
  reference <- extrantsr::check_ants(file.path(dir, list.files(dir)[[1]]))
  file_name <- (dir %>% str_split("/"))[[1]]
  file_name <- file_name[length(file_name)]
  
  if (is_descriptive) {
    descriptive_dir <- file.path(settings$output_dir, "niftis/descriptive")
    dir.create(descriptive_dir, showWarnings = FALSE)
    names <- c("_mean", "_variance")
    for (i in 1:length(image_list)) {
      descriptive_image <- make_ants_image(image_list[[i]], mask_indices, reference)
      ANTsRCore::antsImageWrite(
        descriptive_image,
        file.path(descriptive_dir,
                  paste0(file_name, names[i], ".nii.gz")))
    }
    
    return(NULL)
  }
  
  for (i in 1:length(image_list)) {
    pval_image <- make_ants_image(image_list[[i]], mask_indices, reference)
    ANTsRCore::antsImageWrite(
      pval_image,
      file.path(settings$output_dir, "niftis/pvals/raw",
                paste0(file_name, "_pval_", i, ".nii.gz")
      )
    )
  }
  
  return(NULL)
}

analyze_coupled_images <- function(coupled_dir, mask, predictors, cores = 2) {
  mask <- extrantsr::check_ants(mask)
  image_vector_list <- load_images(coupled_dir, mask)
  voxel_vector_list <- transpose_list(image_vector_list)
  descriptive_list <- make_descriptive_images(voxel_vector_list)
  pvalbyvoxel_list <- parallel::mclapply(voxel_vector_list,
                                         get_pvals_by_voxel,
                                         predictors = predictors,
                                         mc.cores = cores)
  pvalbycoef_list <- transpose_list(pvalbyvoxel_list)
  
  write_pvals(descriptive_list, mask, coupled_dir, is_descriptive = TRUE)
  write_pvals(pvalbycoef_list, mask, coupled_dir)
  
  return(NULL)
}
```

## Run
```{r}
analyze_coupled_images(coupled_dir = file.path(settings$output_dir, "niftis/coupled/global_wcov"),
                       mask = settings$mask_path,
                       predictors = predictors,
                       cores = 16)
analyze_coupled_images(coupled_dir = file.path(settings$output_dir, "niftis/coupled/unscaled_wcor"),
                       mask = settings$mask_path,
                       predictors = predictors,
                       cores = 16)
```


# Perform multiple comparisons

## Functions
```{r}
get_file_name <- function(file_path, pval_name) {
  split_path <- file_path %>% str_split("/")
  full_name <- split_path[[1]][length(split_path[[1]])]
  file_name <- full_name %>% str_remove(".nii.gz")
  
  if (!is.null(pval_name)) {
    file_name <- file_name %>% sub("pval.*", pval_name, .)
  }
  
  return(file_name)
}

process_pval_image <- function(file_path, mask, out_dir, pval_name) {
  mask <- extrantsr::check_ants(mask)
  file_name <- get_file_name(file_path, pval_name)
  pval_image <- check_ants(file_path)
  pval_numeric <- pval_image %>% as.numeric()
  pval_numeric_clean <- pval_numeric[pval_numeric != 0]
  bonferroni_adjusted <- p.adjust(pval_numeric_clean, method = "bonferroni")
  fdr_adjusted <- p.adjust(pval_numeric_clean, method = "fdr")
  
  mask_indices <- which(as.array(mask) > 0)
  
  unadjusted <- convert_to_ants(pval_numeric_clean, 0.05, mask_indices, pval_image)
  bonferroni <- convert_to_ants(bonferroni_adjusted, 0.05, mask_indices, pval_image)
  fdr_image_0.05 <- convert_to_ants(fdr_adjusted, 0.05, mask_indices, pval_image)
  
  dir.create(out_dir, showWarnings = FALSE)
  
  antsImageWrite(unadjusted, file.path(out_dir, paste0(file_name, "_unadjusted.nii.gz")))
  antsImageWrite(bonferroni, file.path(out_dir, paste0(file_name, "_bonferroni.nii.gz")))
  antsImageWrite(fdr_image_0.05, file.path(out_dir, paste0(file_name, "_fdr05.nii.gz")))
  
  return(NULL)
}

convert_to_ants <- function(adjusted_pvals, threshold, mask_indices, reference) {
  adjusted_pvals[adjusted_pvals > threshold] <- 0
  adjusted_pvals[adjusted_pvals != 0] <- 1
  
  adjusted_image <- make_ants_image(adjusted_pvals, mask_indices, reference)
  
  return(adjusted_image)
}

name_pvals <- function(pval_files, pval_names) {
  lapply(pval_files,
         function(pval_file, pval_names) {
           pval_num <- str_extract(pval_file, ".\\.nii\\.gz") %>%
             str_remove("\\.nii\\.gz") %>%
             as.numeric()
           pval_names[pval_num]
         },
         pval_names = pval_names)
}
```

## Run
```{r}
raw_pvals_dir <- file.path(settings$output_dir, "niftis/pvals/raw")

raw_pval_files <- file.path(raw_pvals_dir, list.files(raw_pvals_dir, ".nii.gz"))
pval_names <- c("sex", "age", "sex-age")
pval_name_list <- name_pvals(raw_pval_files, pval_names)

mapply(process_pval_image,
       file_path = raw_pval_files,
       pval_name = pval_name_list,
       MoreArgs = list(
         mask = settings$mask_path,
         out_dir = file.path(settings$output_dir, "niftis/pvals/adjusted")))
```

# Get p-value descriptive stats
## Functions
```{r}
get_file_names <- function(pval_directory) {
  pval_names <- file.path(pval_directory) %>%
    list.files()
  c(pval_names) %>% sub(".nii.gz", "", .)
}

load_pval_images <- function(pval_directory) {
  pval_files <- file.path(pval_directory) %>% list.files(full.names = TRUE)
  
  check_ants(pval_files)
}

get_metadata <- function(pval_names, pval_directory) {
  pval_files <- file.path(pval_directory) %>% list.files(full.names = TRUE)
  
  metadata_df <- pval_names %>%
    str_split("_") %>%
    as.data.frame() %>%
    t() %>%
    as.data.frame()
  rownames(metadata_df) <- 1:nrow(metadata_df)
  colnames(metadata_df) <- c("scaling", "matrix_type", "coefficient", "mc_correction")
  
  metadata_df <- metadata_df %>% mutate(file_paths = pval_files)
  
  metadata_df
}

get_descriptive_stats <- function(pval_image, gm_mask) {
  total_voxels <- sum(gm_mask)
  prop_sig <- sum(pval_image) / total_voxels
  
  data.frame(prop_sig)
}

process_pval_images <- function(pval_directory, gm_mask, image_format = c("ants", "nifti")) {
  gm_mask <- check_ants(gm_mask)
  pval_images <- load_pval_images(pval_directory)
  pval_names <- get_file_names(pval_directory)
  pval_metadata <- get_metadata(pval_names, pval_directory)
  
  pval_metadata_list <- split(pval_metadata, seq(nrow(pval_metadata)))
  
  descriptive_stats <- lapply(pval_images,
                              get_descriptive_stats,
                              gm_mask)
  
  descriptive_stats_df <- descriptive_stats %>%
    unlist() %>%
    as.matrix(byrow = T, ncol = ncol(pval_metadata)) %>%
    as.data.frame()
  names(descriptive_stats_df) <- c("prop_sig")
  rownames(descriptive_stats_df) <- 1:nrow(pval_metadata)
  
  pval_info <- cbind(pval_metadata, descriptive_stats_df)
  
  if (image_format == "nifti") {
    pval_images <- lapply(pval_images, ants2oro)
  }
  
  list(pval_info, pval_images)
}

view_itksnap <- function(pval_info,
                         pval_mask_filter = "brain",
                         directory_filter = NULL,
                         segmentation = NULL,
                         scaling_filter = NULL,
                         fwhm_filter = NULL,
                         coefficient_filter = NULL,
                         mc_correction_filter = NULL,
                         pca_mask_filter = NULL,
                         show_image = TRUE) {
  if (class(segmentation) == "antsImage") {
    segmentation <- ants2oro(segmentation)
  }
  
  tmp <- pval_info
  
  if (!is.null(directory_filter)) {
    tmp <- tmp %>% filter(directory == directory_filter)
  }
  if (!is.null(pval_mask_filter)) {
    tmp <- tmp %>% filter(pval_mask == pval_mask_filter)
  }
  if (!is.null(scaling_filter)) {
    tmp <- tmp %>% filter(scaling == scaling_filter)
  }
  if (!is.null(fwhm_filter)) {
    tmp <- tmp %>% filter(fwhm == fwhm_filter)
  }
  if (!is.null(coefficient_filter)) {
    tmp <- tmp %>% filter(coefficient == coefficient_filter)
  }
  if (!is.null(mc_correction_filter)) {
    tmp <- tmp %>% filter(mc_correction == mc_correction_filter)
  }
  if (!is.null(pca_mask_filter)) {
    tmp <- tmp %>% filter(pca_mask == pca_mask_filter)
  }
  
  print(tmp$prop_sig)
  print(tmp$file_path)
  
  
  file_paths <- tmp$file_paths
  
  if (show_image) {
    if (length(file_paths) == 2) {
      itksnap(file_paths[1], overlay = file_paths[2], segmentation, verbose = F)
    } else {
      for (i in 1:length(file_paths)) {
        itksnap(file_paths[i], segmentation = segmentation, verbose = F)
      }
    }
  }
  
  return(NULL)
}
```

## Run
```{r}
pval_dir <- file.path(settings$output_dir, "niftis/pvals")

pval_image_stats <- process_pval_images(file.path(pval_dir, "adjusted"), settings$mask_path, image_format = "nifti")
pval_stats_df <- pval_image_stats[[1]]
view_itksnap(pval_stats_df,
             pval_mask_filter = NULL,
             directory_filter = "adjusted_gm",
             segmentation = gm_mask,
             scaling_filter = "unscaled",
             fwhm_filter = "fwhm3",
             coefficient_filter = NULL,
             mc_correction_filter = "fdr05",
             pca_mask_filter = "gm-mask",
             show_image = TRUE)

write_csv(pval_stats_df, file.path(settings$output_dir, "csvs/pval_descriptive_stats.csv"))
```

# Generate barcharts
## Functions
```{r}
get_prop_sig <- function(file_paths, file_labels, atlas, mask) {
  pval_masks <- check_ants(file_paths)
  mask <- check_ants(mask)
  
  masked_atlas <- atlas * mask
  network_ids <- masked_atlas[masked_atlas != 0] %>%
    as.factor() %>%
    summary() %>%
    names()
  
  common_mask <- atlas * mask
  common_mask[common_mask != 0] <- 1
  
  sig_voxel_images <- lapply(pval_masks, function(pval_mask) pval_mask * masked_atlas)
  nonsig_voxel_images <- lapply(pval_masks, function(pval_mask) (-pval_mask + 1) * masked_atlas)
  
  for (i in 1:4) {
    sig_sum <- sum(sig_voxel_images[[i]] != 0)
    nonsig_sum <- sum(nonsig_voxel_images[[i]] != 0)
    if (sum(common_mask) != nonsig_sum + sig_sum) {
      stop()
    }
  }
  
  summaries <- mapply(
    function(sig_voxel_image, nonsig_voxel_image, file_label, network_id) {
      sig_summary <- sig_voxel_image[sig_voxel_image != 0] %>%
        as.factor() %>%
        summary() %>%
        as.data.frame() %>%
        rownames_to_column() %>%
        rename(sig_counts = ".")
      
      nonsig_summary <- nonsig_voxel_image[nonsig_voxel_image != 0] %>%
        as.factor() %>%
        summary() %>%
        as.data.frame() %>%
        rownames_to_column() %>%
        rename(nonsig_counts = ".")
      
      map_name <- rep(file_label, length(network_ids))
      
      df <- data.frame(network_ids) %>%
        cbind(map_name) %>%
        left_join(sig_summary, by = c("network_ids" = "rowname")) %>%
        left_join(nonsig_summary, by = c("network_ids" = "rowname"))
      
      return(df)
    },
    sig_voxel_images, nonsig_voxel_images, file_labels,
    MoreArgs = list(network_ids),
    SIMPLIFY = FALSE)
  
  summaries_df <- bind_rows(summaries) %>%
    mutate(proportion = sig_counts / (sig_counts + nonsig_counts),
           se = sqrt(proportion * (1 - proportion) / (sig_counts + nonsig_counts))
    )
  
  return(summaries_df)
}
```

## Run
```{r}
pvals_dir <- file.path(settings$output_dir, "niftis/pvals")
pval_metadata <- read_csv(file.path(settings$output_dir, "csvs", "pval_descriptive_stats.csv"))
yeo7 <- file.path(settings$input_dir, "references/atlases/7yeonetworkPNC.nii.gz") %>% check_ants()
aal <- file.path(settings$input_dir, "references/atlases/AAL_atlas_PNC.nii.gz") %>% check_ants()


# transform aal to yeo7-style mask
aal_sym <- floor(aal/10) * 10

all_indices <- unique(aal_sym)
subcortical_indices <- c(4100, 4200, 7000, 7010, 7020, 7100) # What are the subcortical structures?

excluded_indices <- all_indices[!all_indices %in% subcortical_indices]

for(i in 1:length(excluded_indices)) {
  aal_sym[aal_sym == excluded_indices[i]] <- 0
}

file_labels <- c("global_age", "global_sex", "unscaled_age", "unscaled_sex")

# get file paths
file_paths <- pval_metadata %>%
  filter(coefficient == "sex" | coefficient == "age",
         mc_correction == "fdr05") %>%
  pull(file_paths)

yeo7_df <- get_prop_sig(file_paths, file_labels, yeo7, settings$mask_path)
yeo7_barplot <- ggplot(yeo7_df, aes(network_ids, proportion)) +
  geom_col() +
  geom_errorbar(aes(ymin = proportion - se, ymax = proportion + se), width = .2,
                position = position_dodge(.9)) +
  facet_wrap(~ map_name) +
  labs(title = "PCA on Yeo7") +
  scale_x_discrete(labels = c("Visual", "Somatomotor", "Dorsal Attention", "Ventral Attention", "Limbic", "Frontoparietal", "Default")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)); yeo7_barplot
ggsave(plot = yeo7_barplot, file.path(settings$output_dir, "figures", "yeo7_pval-prop_fdr05.png"), type = "cairo-png")

aal_sym_df <- get_prop_sig(file_paths, file_labels, aal_sym, settings$mask_path)
aal_barplot <- ggplot(aal_sym_df, aes(network_ids, proportion)) +
  geom_col() +
  geom_errorbar(aes(ymin = proportion - se, ymax = proportion + se), width = .2,
                position = position_dodge(.9)) +
  facet_wrap(~ map_name) +
  labs(title = "PCA on AAL") +
  scale_x_discrete(labels = c("Hippocampus", "Amygdala", "Caudate", "Putamen", "Pallidum", "Thalamus")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)); aal_barplot
ggsave(plot = aal_barplot, file.path(settings$output_dir, "figures", "aal_pval-prop_fdr05.png"), type = "cairo-png")


# ---------------------------------------------------

raw_file_paths <- file.path(dir, "adjusted_gm") %>%
  list.files()
raw_file_path_select <- raw_file_paths %>%
  (function(x) grepl("alff|cbf", x) &
     grepl("_sex_|_age_", x) &
     grepl("bonferroni", x))
raw_file_paths <- file.path(file.path(dir, "adjusted_gm"), raw_file_paths[raw_file_path_select])
raw_file_labels <- c("alff_age", "alff_sex", "cbf_age", "cbf_sex")

yeo7_df_raw <- get_prop_sig(raw_file_paths, raw_file_labels, yeo7, gm_mask)
ggplot(yeo7_df_raw, aes(network_ids, proportion)) +
  geom_col() +
  geom_errorbar(aes(ymin = proportion - se, ymax = proportion + se), width = .2,
                position = position_dodge(.9)) +
  facet_wrap(~ map_name) +
  labs(title = "Raw on Yeo7") +
  theme_classic()

aal_sym_df_raw <- get_prop_sig(raw_file_paths, raw_file_labels, aal_sym, gm_mask)
ggplot(aal_sym_df_raw, aes(network_ids, proportion)) +
  geom_col() +
  geom_errorbar(aes(ymin = proportion - se, ymax = proportion + se), width = .2,
                position = position_dodge(.9)) +
  facet_wrap(~ map_name) +
  labs(title = "Raw on AAL") +
  theme_classic()
```


