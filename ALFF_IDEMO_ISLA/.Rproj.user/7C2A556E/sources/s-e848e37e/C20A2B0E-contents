---
title: "IMCo Validation - Three Modality ISLA"
author: "Fengling Hu"
output: html_document
---

# Setup
```{r, include = FALSE}
library(tidyverse)
library(ANTsRCore)
library(extrantsr)
library(IMCo)
library(here)
```

## File names
```{r}
idemo_qa <- read_csv(here("input/csvs/idemodata/n1601_idemo_FinalQA_092817.csv"))
idemo <- read_csv(here("input/csvs/idemodata/n1601_idemoBehavior_20151130.csv"))
idemo_health <- read_csv(here("input/csvs/idemodata/n1601_health_20170421.csv"))
pnc_demographics <- read_csv(here("input/csvs/demographics/binded_demographics.csv"))

idemo_qa <- idemo_qa %>% filter(idemoExcludeVoxelwise == 0)
idemo <- idemo %>% filter(idemoBehHappyCorrectCount >= 8)
idemo_health <- idemo_health %>% filter(ltnExcludev2 == 0)
pnc_demographics <- pnc_demographics %>% rename(scanid = "id")

common_pts <- Reduce(intersect, list(idemo_qa$scanid, idemo$scanid, idemo_health$scanid, pnc_demographics$scanid)) %>%
  as.data.frame() %>%
  rename(subj_num = ".")

input_filepaths <- common_pts %>% 
  mutate(modality_1 = paste0(subj_num, "_alffStd.nii.gz") %>% file.path("input/niftis/alff", .)) %>% 
  mutate(modality_2 = paste0(subj_num, "_asl_quant_ssT1Std.nii.gz")%>% file.path("input/niftis/cbf", .)) %>% 
  mutate(modality_3 = paste0(subj_num, "_sigchange_cope1_TaskStd.nii.gz") %>% file.path("input/niftis/idemo", .))

rm(common_pts, idemo, idemo_health, idemo_qa)
```

## Global Settings
```{r}
output_dir <- here("output") #base directory for all outputs
input_dir <- here("input") #base directory for all inputs
nifti_dir <- file.path(input_dir, 
                       list("niftis/alff",
                            "niftis/cbf",
                            "niftis/idemo"))
mask_path <- file.path(input_dir, "references/masks/gm10_pcals_rest.nii.gz")

settings <- list(output_dir = output_dir,
                 input_dir = input_dir,
                 nifti_dir = nifti_dir,
                 mask_path = mask_path)
```

# Intermodal Coupling
```{r}
global_wcov <- imco(files, mask,
  ref = 1, fwhm = 3, retimg = T, type = "pca",
  propMiss = 0.9, pcaType = "global", matrixType = "wcov"
)
```

