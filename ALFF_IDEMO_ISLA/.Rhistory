library(tidyverse)
library(ANTsRCore)
library(extrantsr)
library(IMCo)
library(parallel)
library(here)
library(freesurfer)
#TOCHANGE
idemo_qa <- read_csv(here("input/csvs/idemodata/n1601_idemo_FinalQA_092817.csv"))
idemo <- read_csv(here("input/csvs/idemodata/n1601_idemoBehavior_20151130.csv"))
idemo_health <- read_csv(here("input/csvs/idemodata/n1601_health_20170421.csv"))
pnc_demographics <- read_csv(here("input/csvs/demographics/binded_demographics.csv"))
isla_subj <- read_table(here("input/csvs/demographics/isla_subj.txt"), col_names = FALSE)
idemo_qa <- idemo_qa %>% filter(idemoExcludeVoxelwise == 0)
idemo <- idemo %>% filter(idemoBehHappyCorrectCount >= 8)
idemo_health <- idemo_health %>% filter(ltnExcludev2 == 0)
pnc_demographics <- pnc_demographics %>% rename(scanid = "id")
isla_subj <- isla_subj %>% separate(X1, c("scanid", "settings", "file_root"), sep = "_")
common_pts <- Reduce(intersect, list(idemo_qa$scanid, idemo$scanid, idemo_health$scanid, pnc_demographics$scanid, basil_subj$scanid)) %>%
as.data.frame() %>%
rename(subj_num = ".")
input_filepaths <- common_pts %>%
mutate(modality_1 = paste0(subj_num, "_alffStd.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/alff", .),
modality_2 = paste0(subj_num, "_predictedGMD1.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/cbf-isla", .),
modality_3 = paste0(subj_num, "_sigchange_cope1_TaskStd.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/idemo", .))
input_filepaths$subj_num <- as.numeric(input_filepaths$subj_num)
write_csv(input_filepaths, here("input/csvs/input_filepaths.csv"))
rm(pnc_demographics, common_pts, idemo, idemo_health, basil_subj)
#TOCHANGE
idemo_qa <- read_csv(here("input/csvs/idemodata/n1601_idemo_FinalQA_092817.csv"))
idemo <- read_csv(here("input/csvs/idemodata/n1601_idemoBehavior_20151130.csv"))
idemo_health <- read_csv(here("input/csvs/idemodata/n1601_health_20170421.csv"))
pnc_demographics <- read_csv(here("input/csvs/demographics/binded_demographics.csv"))
isla_subj <- read_table(here("input/csvs/demographics/isla_subj.txt"), col_names = FALSE)
idemo_qa <- idemo_qa %>% filter(idemoExcludeVoxelwise == 0)
idemo <- idemo %>% filter(idemoBehHappyCorrectCount >= 8)
idemo_health <- idemo_health %>% filter(ltnExcludev2 == 0)
pnc_demographics <- pnc_demographics %>% rename(scanid = "id")
isla_subj <- isla_subj %>% separate(X1, c("scanid", "settings", "file_root"), sep = "_")
common_pts <- Reduce(intersect, list(idemo_qa$scanid, idemo$scanid, idemo_health$scanid, pnc_demographics$scanid, basil_subj$scanid)) %>%
as.data.frame() %>%
rename(subj_num = ".")
input_filepaths <- common_pts %>%
mutate(modality_1 = paste0(subj_num, "_alffStd.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/alff", .),
modality_2 = paste0(subj_num, "_predictedGMD1.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/cbf-isla", .),
modality_3 = paste0(subj_num, "_sigchange_cope1_TaskStd.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/idemo", .))
input_filepaths$subj_num <- as.numeric(input_filepaths$subj_num)
write_csv(input_filepaths, here("input/csvs/input_filepaths.csv"))
rm(pnc_demographics, common_pts, idemo, idemo_health, isla_subj)
isla_subj <- read_table(here("input/csvs/demographics/isla_subj.txt"), col_names = FALSE)
#TOCHANGE
idemo_qa <- read_csv(here("input/csvs/idemodata/n1601_idemo_FinalQA_092817.csv"))
idemo <- read_csv(here("input/csvs/idemodata/n1601_idemoBehavior_20151130.csv"))
idemo_health <- read_csv(here("input/csvs/idemodata/n1601_health_20170421.csv"))
pnc_demographics <- read_csv(here("input/csvs/demographics/binded_demographics.csv"))
isla_subj <- read_table(here("input/csvs/demographics/isla_subj.txt"), col_names = FALSE)
idemo_qa <- idemo_qa %>% filter(idemoExcludeVoxelwise == 0)
idemo <- idemo %>% filter(idemoBehHappyCorrectCount >= 8)
idemo_health <- idemo_health %>% filter(ltnExcludev2 == 0)
pnc_demographics <- pnc_demographics %>% rename(scanid = "id")
isla_subj <- isla_subj %>% separate(X1, c("scanid", "settings", "file_root"), sep = "_")
common_pts <- Reduce(intersect, list(idemo_qa$scanid, idemo$scanid, idemo_health$scanid, pnc_demographics$scanid, isla_subj$scanid)) %>%
as.data.frame() %>%
rename(subj_num = ".")
input_filepaths <- common_pts %>%
mutate(modality_1 = paste0(subj_num, "_alffStd.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/alff", .),
modality_2 = paste0(subj_num, "_predictedGMD1.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/cbf-isla", .),
modality_3 = paste0(subj_num, "_sigchange_cope1_TaskStd.nii.gz") %>% file.path("~/Documents/IMCo_analyses/input/niftis/idemo", .))
input_filepaths$subj_num <- as.numeric(input_filepaths$subj_num)
write_csv(input_filepaths, here("input/csvs/input_filepaths.csv"))
rm(pnc_demographics, common_pts, idemo, idemo_health, isla_subj)
#TOCHANGE
idemo_qa <- idemo_qa %>% rename(subj_num = scanid)
demographics <- read_csv(here("input/csvs/demographics/binded_demographics.csv")) %>%
rename(subj_num = id)
demographics <- right_join(demographics, input_filepaths,
by = "subj_num") %>%
left_join(idemo_qa, by = "subj_num") %>% mutate(across(contains("Exclude"), as.factor),
sex = case_when(
sex == 1 ~ "Male",
sex == 2 ~ "Female",
T ~ NA_character_),
race2 = case_when(
race2 == 1 ~ "White",
race2 == 2 ~ "Black",
race2 == 3 ~ "Other",
T ~ NA_character_),
across(c(sex, race, race2, ethnicity, handednessv2), as.factor))
predictors <- demographics %>%
select(sex, ageAtScan1, race2, pcaslRelMeanRMSMotion, restRelMeanRMSMotion, idemoRelMeanRMSMotion)
write_csv(predictors, file.path(here("input/csvs/predictors.csv")))
rm(demographics, idemo_qa)
#TOCHANGE
output_dir <- here("output") #base directory for all outputs
input_dir <- here("input") #base directory for all inputs
nifti_dir <- "~/Documents/IMCo_analyses/input/niftis"
batch_script_dir <- here("R/batch_scripts")
input_filepaths_path = file.path(input_dir, "csvs/input_filepaths.csv")
mask_path <- file.path(input_dir, "references/masks/gm10_pcals_rest.nii.gz")
predictors_path <- file.path(input_dir, "csvs/predictors.csv")
settings_path <- file.path(input_dir, "csvs/settings.RData")
modalities <- c("alff", "cbf-basil", "idemo") #TOCHANGE
fwhm <- 2 #TOCHANGE
prop_miss <- 0.9
settings <- list(output_dir = output_dir,
input_dir = input_dir,
nifti_dir = nifti_dir,
batch_script_dir = batch_script_dir,
input_filepaths_path = input_filepaths_path,
mask_path = mask_path,
predictors_path = predictors_path,
settings_path = settings_path,
modalities = modalities,
fwhm = fwhm,
prop_miss = prop_miss)
save(settings, file = file.path(settings$input_dir, "csvs/settings.RData"))
rm(output_dir, input_dir, nifti_dir, batch_script_dir, input_filepaths_path, mask_path, predictors_path, settings_path, modalities, fwhm, prop_miss)
#TOCHANGE
output_dir <- here("output") #base directory for all outputs
input_dir <- here("input") #base directory for all inputs
nifti_dir <- "~/Documents/IMCo_analyses/input/niftis"
batch_script_dir <- here("R/batch_scripts")
input_filepaths_path = file.path(input_dir, "csvs/input_filepaths.csv")
mask_path <- file.path(input_dir, "references/masks/gm10_pcals_rest.nii.gz")
predictors_path <- file.path(input_dir, "csvs/predictors.csv")
settings_path <- file.path(input_dir, "csvs/settings.RData")
modalities <- c("alff", "cbf-isla", "idemo") #TOCHANGE
fwhm <- 2 #TOCHANGE
prop_miss <- 0.9
settings <- list(output_dir = output_dir,
input_dir = input_dir,
nifti_dir = nifti_dir,
batch_script_dir = batch_script_dir,
input_filepaths_path = input_filepaths_path,
mask_path = mask_path,
predictors_path = predictors_path,
settings_path = settings_path,
modalities = modalities,
fwhm = fwhm,
prop_miss = prop_miss)
save(settings, file = file.path(settings$input_dir, "csvs/settings.RData"))
rm(output_dir, input_dir, nifti_dir, batch_script_dir, input_filepaths_path, mask_path, predictors_path, settings_path, modalities, fwhm, prop_miss)
load(here("input/csvs/settings.RData"))
input_filepaths <- read_csv(settings$input_filepaths_path)
predictors <- read_csv(settings$predictors_path)
bash_file <- rep(0, nrow(input_filepaths))
for(i in 1:nrow(input_filepaths)) {
line <- input_filepaths[i, ]
out_name <- line[1]
subject_files <- paste(line[1, 2], line[1, 3], line[1, 4], sep = ",") #TOCHANGE
bsub_args <- paste("bsub",
"-q taki_normal",
paste("-J", shQuote("intermodal_coupling")),
paste("-R", shQuote("rusage[mem=4000]")),
"-M 10000",
paste("-o", file.path(settings$output_dir, "stdout/intermodal_coupling.txt")))
Rscript_args <- paste("Rscript", file.path(settings$batch_script_dir, "01_perform_imco.R"),
subject_files,
settings$mask_path,
settings$output_dir,
out_name,
settings$fwhm,
settings$prop_miss)
bash_file[i] <- paste(bsub_args, Rscript_args)
}
write_lines(bash_file, file.path(settings$batch_script_dir, "01_commands.sh"))
#TORUNOTHER here("R/batch_scripts/01_commands.sh") on login node
#TOCOPY
#Make sure to move 01_perform_imco.R into new directory
rm(bash_file, i, line, out_name, subject_files, bsub_args, Rscript_args)
get_file_name <- function(file_path, pval_name) {
split_path <- file_path %>% str_split("/")
full_name <- split_path[[1]][length(split_path[[1]])]
file_name <- full_name %>% str_remove(".nii.gz")
if (!is.null(pval_name)) {
file_name <- file_name %>% sub("pval.*", pval_name, .)
}
return(file_name)
}
process_pval_image <- function(file_path, mask, out_dir, pval_name) {
mask <- extrantsr::check_ants(mask)
mask_indices <- which(as.array(mask) > 0)
file_name <- get_file_name(file_path, pval_name)
pval_image <- check_ants(file_path)
pval_numeric <- pval_image %>% as.numeric()
pval_numeric_clean <- pval_numeric[mask_indices]
bonferroni_adjusted <- p.adjust(pval_numeric_clean, method = "bonferroni")
fdr_adjusted <- p.adjust(pval_numeric_clean, method = "fdr")
unadjusted <- convert_to_ants(pval_numeric_clean, 0.05, mask_indices, pval_image)
bonferroni <- convert_to_ants(bonferroni_adjusted, 0.05, mask_indices, pval_image)
fdr_image_0.05 <- convert_to_ants(fdr_adjusted, 0.05, mask_indices, pval_image)
dir.create(out_dir, showWarnings = FALSE)
antsImageWrite(unadjusted, file.path(out_dir, paste0(file_name, "_unadjusted.nii.gz")))
antsImageWrite(bonferroni, file.path(out_dir, paste0(file_name, "_bonferroni.nii.gz")))
antsImageWrite(fdr_image_0.05, file.path(out_dir, paste0(file_name, "_fdr05.nii.gz")))
return(NULL)
}
convert_to_ants <- function(adjusted_pvals, threshold, mask_indices, reference) {
adjusted_pvals[adjusted_pvals > threshold] <- 0
adjusted_pvals[adjusted_pvals != 0] <- 1
adjusted_image <- make_ants_image(adjusted_pvals, mask_indices, reference)
return(adjusted_image)
}
name_pvals <- function(pval_files, pval_names) {
lapply(pval_files,
function(pval_file, pval_names) {
pval_num <- str_extract(pval_file, ".\\.nii\\.gz") %>%
str_remove("\\.nii\\.gz") %>%
as.numeric()
pval_names[pval_num]
},
pval_names = pval_names)
}
perform_mc <- function(raw_pvals_dir, adjusted_pvals_dir){
raw_pval_files <- file.path(raw_pvals_dir, list.files(raw_pvals_dir, ".nii.gz"))
pval_names <- c("sex", "age", "sex-age")
pval_name_list <- name_pvals(raw_pval_files, pval_names)
mapply(process_pval_image,
file_path = raw_pval_files,
pval_name = pval_name_list,
MoreArgs = list(
mask = settings$mask_path,
out_dir = adjusted_pvals_dir))
}
